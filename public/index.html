<!DOCTYPE html>
<html lang="en" ng-app="ChatApp">
    <head>
        <meta charset="utf-8">
        <title>Chat</title>
        <link rel="stylesheet" type="text/css" href="main.css">
        <link rel="stylesheet" type="text/css" href="top-menu.css">
        <link rel="stylesheet" type="text/css" href="registered-users.css">
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
        <link href="registered-users.html">
        <link href="bubbles.html">
        <link href="start-conv.html">
        <link href="conv.html">
        <link href="top-menu.html">
        <script src="js/main.js"></script>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Pacifico" rel="stylesheet">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">

        <!-- Angular Material requires Angular.js Libraries -->
        <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!-- Angular Material Library -->
        <script src="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>

    </head>
    <body ng-controller="ChatController" ng-init="isOpen=false">
        <section>
            <h1 class="app-name">Chat App</h1>
        </section>
        <md-whiteframe class="md-whiteframe-20dp cont">
    
            <div ng-include="'top-menu.html'"></div>
            <div ng-include="'registered-users.html'"></div>

            <md-whiteframe ng-show="loggedIn" class="md-whiteframe-9dp home-button-container">
                <div class="home-container preview-glyphs" ng-click="stopAndBackToHome()">
                    <md-icon md-font-icon="icon-home" style="color:black; font-size: 32px; height: 32px">home</md-icon>
                </div>
            </md-whiteframe>


            <md-whiteframe class="md-whiteframe-20dp cont2">

                <div class="content-container">
                    <a ng-show="!loggedIn" href="{{loginUri}}" style="text-align: center; top: 50%; left:50%; position: absolute">Log in</a>
                    
                    <md-content class="non-bubble-container" ng-show="loggedIn">
                        <md-tabs md-dynamic-height md-border-bottom md-selected="selectedIndex">

                            <md-tab label="New Conversation">
                                <md-content class="md-padding flex-col">

                                    <md-content class="conv-users-container">
                                        <md-list flex>
                                            <md-list-item class="md-1-line" ng-repeat="usr in users" ng-click="addUserToConv(usr)"  ng-class="isAlreadyInConv(usr) ? 'disabled' : 'enabled'" ng-if="user._id!==usr._id">
                                                <img ng-src="{{usr.avatarUrl}}?{{$index}}" class="md-avatar" alt="{{item.who}}" />
                                                <div class="md-list-item-text" layout="column">
                                                    <p>{{usr.name}}</p>
                                                </div>
                                            </md-list-item>
                                        </md-list>
                                    </md-content>

                                    <md-input-container flex="50">
                                        <label>Chat Name</label>
                                        <input required name="chatName" ng-model="inputConvName">
                                        <div ng-messages="inputConvName.$error" md-auto-hide="false">
                                            <div ng-message="required">This is required.</div>
                                        </div>
                                    </md-input-container>

                                    <button class="chat-now-btn" ng-click="startConversation(inputConvName);" ng-disabled="inputConvName===''||inputno.length===0">CHAT NOW</button>

                                </md-content>
                            </md-tab>

                            <md-tab ng-if="showConversation" label="{{conv.name}}">
                                <md-content class="flex-col">
                                        <md-menu-bar style="padding: 0px">
                                                <md-button style="padding: 0px; margin: 0px" ng-click="clearConversation()">
                                                    <md-icon>delete_sweep</md-icon>
                                                </md-button>

                                                <md-button style="padding: 0px; margin: 0px" ng-click="showUsers=true">
                                                    <md-icon>group_add</md-icon>
                                                </md-button>

                                                <md-button style="padding: 0px; margin: 0px" ng-click="edittingName=true">
                                                    <md-icon>edit</md-icon>
                                                </md-button>
                                            
                                                <md-button style="padding: 0px; margin: 0px" ng-click="leaveConversation()">
                                                    <md-icon>keyboard_tab</md-icon>
                                                </md-button>
                                        </md-menu-bar>

                                        <form ng-show="edittingName">
                                            <input ng-model="conv.name"></input>
                                            <md-button type="submit" ng-click="updateNameConv(conv.name);edittingName=false;">
                                                <md-icon>done</md-icon>
                                            </md-button>
                                        </form>

                                        <md-content class="conv-users-container" style="background-color:white">
                                            <md-list flex>
                                                <md-list-item class="md-2-line" ng-repeat="msg in messages">
                                                    <img ng-src="{{user.avatarUrl}}?{{$index}}" class="md-avatar" alt="{{item.who}}" />
                                                    <div class="md-list-item-text" layout="column">
                                                        <p>{{msg.from}}: Time: {{msg.time}}</p>
                                                        <h5>{{msg.messageText}}</h5>
                                                    </div>
                                                </md-list-item>
                                            </md-list>
                                        </md-content>

                                        <div ng-show="showUsers">
                                            <ul ng-init="inputno=[]">
                                              <li ng-repeat="user in users" ng-if="conv.users.indexOf(user._id)<0" ng-class="isAlreadyInConv(user) ? 'disabled' : 'enabled'">
                                                  <a ng-click="addUserToConv(user);">{{user.name}}</a>
                                              </li>
                                            </ul>
                                            <button type="button" ng-click="addUsersToConversation(); showUsers=false;">Add</button>
                                        </div>

                                        <form class="send-msg" name="myForm" ng-submit="sendMessage(myForm.newMessage); myForm.newMessage='';">
                                            <input style="width: 200px" type="text" ng-model="myForm.newMessage"></input>
                                            <md-button type="submit" ng-disabled="myForm.newMessage===''">
                                                <md-icon>send</md-icon>
                                            </md-button>
                                        </form>

                                </md-content>
                            </md-tab>

                        </md-tabs>
                    </md-content>


                    <!-- <div ng-include="'start-conv.html'"></div> -->

                    <!-- <div ng-include="'conv.html'"></div> -->

                    <!-- <div ng-include="'bubbles.html'"></div> -->


                     <div ng-hide="!loggedIn" class="bubble-container">
                        <div class="bubble-inside">
                            <div ng-repeat="conv in conversations track by $index" ng-style="{'align-self': aligs[$index]}">
                                <div class="bubble" ng-style="{'width': convSize[$index] + 'px', 'height': convSize[$index] + 'px', 'background-color': convCol[$index]}" ng-click="openConversation(conv);"><div ng-show="conv.unread!==undefined&&conv.unread!==0" style="text-align: center" ng-style="{margin: convSize[$index]/3 + 'px'}">{{conv.unread}}</div><div id="popup">{{conv.name}}</div></div>
                            </div>
                        </div>
                    </div>


                </div>


            </div>
        </md-whiteframe>


    </body>
</html>